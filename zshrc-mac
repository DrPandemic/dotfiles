# zmodload zsh/zprof

[[ -x /opt/homebrew/bin/brew ]] && eval $(/opt/homebrew/bin/brew shellenv)
# Source Prezto.
if [[ -s "${ZDOTDIR:-$HOME}/.zprezto/init.zsh" ]]; then
  source "${ZDOTDIR:-$HOME}/.zprezto/init.zsh"
fi

# User configuration
export TERM='screen-256color'

alias htop TERM=screen htop
alias gclean='git branch --merged main | grep -v "\* main" | grep -v ".*main" | xargs -n 1 git branch -d'
#alias ping=prettyping

alias g=git
alias devdus='dev down && dev up && dev s'
alias devdut='dev down && dev up && dev t'
alias devdu='dev down && dev up'
alias devus='dev up && dev s'
alias devut='dev up && devt'
alias devst='dev style --include-branch-commits --all-cops'
alias devt='dev t --include-branch-commits '
alias devs='dev s'
alias devu='dev u'
alias devd='dev d'
alias devc='dev c'
alias devuc='dev u && dev c'
alias devduc='dev d && dev u && dev c'
alias devv='dev typecheck && dev style --include-branch-commits && devt'
alias devvv='dev typecheck && dev style -a && dev t'
alias devuv='devu && devv'
alias devuv='devdu && devv'
alias chrome="/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome"
alias t="dev test"
alias g="git"
alias tap="bin/tapioca"
alias gql="open 'https://app.myshopify.io/services/internal/shops/1/graphql?appID=1830279&versionHandle=unstable'"
function kp() {
  local port="$1"
  local pids=$(lsof -t -i:"$port")
  
  if [[ -z "$pids" ]]; then
    echo "No process found running on port $port"
    return 1
  else
    echo "Killing process(es) on port $port"
    echo "$pids" | xargs kill -9
    echo "Process(es) killed successfully"
  fi
}

export EDITOR='vim'
#export CC=clang
#export CXX=clang++

if [[ -z $TMUX ]]; then
  tmux a || tmux
fi

function devdomain() {
  echo "s = OpenSrsDomainSubscription.create!(host: '$1', shop: Shop.first); DomainHandler.create!(host: \"www.#{s.host}\", shop: s.shop, subscription: s); DomainHandler.create!(host: s.host, shop: s.shop, subscription: s); s.update(status: 'registered')" | dev console
}

function :q() {
  exit
}

function sed_regex() {
  rg -l "$1" | xargs sed -i '' -e 's|'$1'|'$2'|g'
}

function dev {
  unset -f dev
  [ -f /opt/dev/dev.sh ] && source /opt/dev/dev.sh
  dev "$@"
}

# gpg
export GPG_TTY=$(tty) 
alias yubi="echo test | gpg --status-fd=2 -bsau '3A3DA70B98A24875C07EFA4C29A9006B1AAE5506'\!''"

function ss {
  #yubi
  spin shell "$@"
}

function ks() {
  if [ -z "$1" ]; then
    echo "Usage: ks <port>"
    return 1
  fi

  local pids=$(lsof -t -i:$1)

  if [ -n "$pids" ]; then
    echo "$pids" | xargs kill -9
    echo "Killed processes on port $1"
  else
    echo "No processes found on port $1"
  fi
}

#bindkey -v
#bindkey fd vi-cmd-mode
# Timeout after escape
export KEYTIMEOUT=1
bindkey '^E' end-of-line
bindkey '^A' beginning-of-line

[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

eval "$(shadowenv init zsh)"

[[ -f /opt/dev/sh/chruby/chruby.sh ]] && { type chruby >/dev/null 2>&1 || chruby () { source /opt/dev/sh/chruby/chruby.sh; chruby "$@"; } }

# Don't save commands starting with a space
setopt HIST_IGNORE_SPACE

unset CC
unset CXX

# spin
zstyle ':completion:*' use-cache on
# Removed auto completion
#autoload -Uz compinit && compinit
source <(spin completion)

export PATH=$PATH:~/Projects/bin

# zprof

# Shopify Hydrogen alias to local projects
alias h2='$(npm prefix -s)/node_modules/.bin/shopify hydrogen'

# cloudplatform: add Shopify clusters to your local kubernetes config
export KUBECONFIG=${KUBECONFIG:+$KUBECONFIG:}/Users/jsaubry/.kube/config:/Users/jsaubry/.kube/config.shopify.cloudplatform

# For Graal
export SDKROOT=$(xcrun --show-sdk-path)
export SYSTEM_RUBY=/usr/bin/ruby
alias jt=/Users/jsaubry/Projects/truffleruby-ws/truffleruby/bin/jt

# is-it-shipped
fpath=(~/.zsh/functions $fpath)
#autoload -Uz ~/.zsh/functions/[^_]*(.:t)
autoload -Uz ~/.zsh/functions/*
